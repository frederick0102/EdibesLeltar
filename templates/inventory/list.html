{% extends "base.html" %}
{% from "macros/components.html" import page_header, category_badge, barcode_display, empty_state, product_name %}

{% block title %}K√©szlet - Edibes Lelt√°r{% endblock %}

{% block extra_css %}
<style>
    .location-breakdown {
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }
    .location-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.4rem;
        border-radius: 0.25rem;
        margin-right: 0.25rem;
        margin-bottom: 0.15rem;
        font-size: 0.7rem;
    }
    .location-warehouse { background-color: #e3f2fd; color: #1565c0; }
    .location-car { background-color: #fff3e0; color: #e65100; }
    .location-vending { background-color: #f3e5f5; color: #7b1fa2; }
    .total-badge {
        background-color: #f5f5f5;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {{ page_header(
        title='K√©szlet',
        subtitle='Aktu√°lis k√©szlet√°llapot helysz√≠nenk√©nt',
        icon='boxes',
        button_text='K√©szletmozg√°s',
        button_url=url_for('inventory.add_movement')
    ) }}
    
    <!-- Sz≈±r≈ëk -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('inventory.list_inventory') }}" class="row g-3">
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" name="search" 
                               placeholder="Keres√©s..." value="{{ search }}">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="category">
                        <option value="">√ñsszes kateg√≥ria</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id %}selected{% endif %}>
                            {{ cat.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="location">
                        <option value="">üåç √ñsszes helysz√≠n</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}" {% if selected_location == loc.id %}selected{% endif %}>
                            {{ LocationType.get_icon(loc.location_type) }} {{ loc.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="stock">
                        <option value="">√ñsszes k√©szlet</option>
                        <option value="low" {% if stock_filter == 'low' %}selected{% endif %}>Alacsony k√©szlet</option>
                        <option value="zero" {% if stock_filter == 'zero' %}selected{% endif %}>Nulla k√©szlet</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-funnel me-1"></i>Sz≈±r√©s
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Helysz√≠n √∂sszes√≠t≈ë (ha nincs sz≈±r≈ë) -->
    {% if not selected_location %}
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>
            <span><strong>√ñsszes√≠tett n√©zet:</strong> Az al√°bbi t√°bl√°zat az √∂sszes helysz√≠n k√©szlet√©t mutatja √∂sszes√≠tve. A helysz√≠nenk√©nti bont√°s minden term√©kn√©l l√°that√≥.</span>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <span>
                <i class="bi bi-filter me-2"></i>
                <strong>Sz≈±rt n√©zet:</strong> Csak a kiv√°lasztott helysz√≠n k√©szlete l√°that√≥.
            </span>
            <a href="{{ url_for('inventory.list_inventory') }}" class="btn btn-sm btn-outline-warning">
                <i class="bi bi-x me-1"></i>Sz≈±r≈ë t√∂rl√©se
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- K√©szlet lista -->
    <div class="card border-0 shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Term√©k</th>
                        <th>Kateg√≥ria</th>
                        <th>Vonalk√≥d</th>
                        <th class="text-center">
                            {% if selected_location %}
                            K√©szlet
                            {% else %}
                            √ñssz. k√©szlet<br>
                            <small class="text-muted fw-normal">Helysz√≠nenk√©nti bont√°s</small>
                            {% endif %}
                        </th>
                        <th class="text-center">Min.</th>
                        <th class="text-end">M≈±veletek</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inventory %}
                    <tr class="{% if item.current_quantity < item.min_stock_level %}{% if item.current_quantity == 0 %}table-danger{% else %}table-warning{% endif %}{% endif %}"
                        id="row-{{ item.id }}">
                        <td>
                            <strong>{{ item.name }}</strong>
                            {% if item.package_size or item.unit_abbr %}
                            <small class="text-muted ms-1">({{ item.package_size or '' }}{% if item.package_size and item.unit_abbr %} {% endif %}{{ item.unit_abbr or '' }})</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ category_badge(item.category_name) }}
                        </td>
                        <td>
                            {{ barcode_display(item.barcode) }}
                        </td>
                        <td class="text-center">
                            <!-- √ñssz mennyis√©g -->
                            <div>
                                <span class="fs-5 fw-bold quantity-display" id="qty-{{ item.id }}">
                                    {{ "%.0f"|format(item.current_quantity) }}
                                </span>
                                <small class="text-muted">db</small>
                                {% if not selected_location %}
                                <span class="total-badge ms-1">√∂sszesen</span>
                                {% endif %}
                            </div>
                            
                            <!-- Helysz√≠nenk√©nti bont√°s -->
                            {% if not selected_location and item.id in location_quantities %}
                            <div class="location-breakdown">
                                {% for loc in location_quantities[item.id] %}
                                <span class="location-badge location-{{ loc.location_type|lower }}">
                                    {{ LocationType.get_icon(loc.location_type) }}
                                    {{ loc.location_name }}: <strong>{{ "%.0f"|format(loc.quantity) }}</strong>
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="text-center text-muted">
                            {{ "%.0f"|format(item.min_stock_level) }}
                        </td>
                        <td class="text-end">
                            <div class="dropdown">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-lightning-charge me-1"></i>Gyors m≈±velet
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><h6 class="dropdown-header">K√©szletmozg√°s</h6></li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('inventory.add_movement') }}?product={{ item.id }}&type=STOCK_IN">
                                            <i class="bi bi-box-arrow-in-down text-success me-2"></i>Bev√©telez√©s
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('inventory.add_movement') }}?product={{ item.id }}&type=STOCK_OUT">
                                            <i class="bi bi-box-arrow-up text-danger me-2"></i>Kiv√©telez√©s
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('inventory.add_movement') }}?product={{ item.id }}&type=ADJUSTMENT">
                                            <i class="bi bi-sliders text-warning me-2"></i>Korrekci√≥
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('inventory.add_movement') }}?product={{ item.id }}&type=LOSS">
                                            <i class="bi bi-trash text-secondary me-2"></i>Selejt
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">√Åthelyez√©s</h6></li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('transfer.quick_transfer') }}?product={{ item.id }}">
                                            <i class="bi bi-arrow-left-right text-info me-2"></i>Helysz√≠nek k√∂z√∂tt
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="{{ url_for('inventory.movement_history') }}?product={{ item.id }}">
                                            <i class="bi bi-clock-history text-muted me-2"></i>Mozg√°s t√∂rt√©net
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    {{ empty_state('Nincs tal√°lat', 6) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="mt-3 text-muted">
        <small>√ñsszesen: {{ inventory|length }} term√©k</small>
    </div>
    
    <!-- R√©szletek modalok -->
    {% for item in inventory %}
    <div class="modal fade" id="detailModal{{ item.id }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        {{ item.name }}
                        {% if item.package_size or item.unit_abbr %}
                        <small class="text-muted">({{ item.package_size or '' }}{% if item.package_size and item.unit_abbr %} {% endif %}{{ item.unit_abbr or '' }})</small>
                        {% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Bez√°r√°s"></button>
                </div>
                <div class="modal-body">
                    <!-- √ñsszes√≠tett k√©szlet -->
                    <div class="text-center mb-4">
                        <div class="display-4 fw-bold text-primary">{{ "%.0f"|format(item.current_quantity) }}</div>
                        <div class="text-muted">√ñsszes k√©szlet</div>
                    </div>
                    
                    <!-- Helysz√≠nenk√©nti bont√°s -->
                    <h6 class="mb-3"><i class="bi bi-geo-alt me-1"></i>K√©szlet helysz√≠nenk√©nt</h6>
                    {% if item.id in location_quantities %}
                    <div class="list-group">
                        {% for loc in location_quantities[item.id] %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <span class="me-2">{{ LocationType.get_icon(loc.location_type) }}</span>
                                {{ loc.location_name }}
                                <small class="text-muted">({{ LocationType.get_label(loc.location_type) }})</small>
                            </span>
                            <span class="badge bg-primary rounded-pill fs-6">{{ "%.0f"|format(loc.quantity) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox"></i> Nincs k√©szlet egyik helysz√≠nen sem
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('inventory.add_movement') }}?product={{ item.id }}" class="btn btn-primary">
                        <i class="bi bi-plus-minus me-1"></i>Mozg√°s r√∂gz√≠t√©s
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bez√°r√°s</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit: select v√°ltoz√°skor azonnal sz≈±r√©s
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="GET"]');
    if (form) {
        // Minden select elemre auto-submit
        form.querySelectorAll('select').forEach(function(select) {
            select.addEventListener('change', function() {
                form.submit();
            });
        });
    }
});
</script>
{% endblock %}
